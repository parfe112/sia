<script is:inline>
  // Check if we are in Google Tag Manager preview mode
  function isGTMPreviewMode() {
    return window.location.search.includes("gtm_debug");
  }

  // If preview mode is detected, load GTM normally
  if (isGTMPreviewMode()) {
    const gtmScript = document.createElement("script");
    gtmScript.src = "https://www.googletagmanager.com/gtag/js?id=GTM-M8DW7D24";
    gtmScript.async = true;
    document.head.appendChild(gtmScript);

    const gtmInit = document.createElement("script");
    gtmInit.innerHTML = `
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "GTM-M8DW7D24");
    `;
    document.head.appendChild(gtmInit);
  }

  // Add a global fetch interceptor to handle CORS issues with Google services
  const originalFetch = window.fetch;
  window.fetch = function (url, options) {
    // If the request is to a Google service, use no-cors mode
    if (
      typeof url === "string" &&
      (url.includes("googleads.g.doubleclick.net") ||
        url.includes("www.googletagmanager.com") ||
        url.includes("www.googleadservices.com"))
    ) {
      options = options || {};
      options.mode = "no-cors";

      // For debugging
      console.debug("Setting no-cors mode for Google service request:", url);
    }

    return originalFetch.call(this, url, options);
  };
</script>

<!-- Default Partytown version for regular users -->
<script
  type="text/partytown"
  src="https://www.googletagmanager.com/gtag/js?id=GTM-M8DW7D24"></script>
<script type="text/partytown">
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "GTM-M8DW7D24");

  // Configure XMLHttpRequest for Google services to avoid CORS issues
  const originalOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function (
    method,
    url,
    async,
    user,
    password
  ) {
    // Set withCredentials to false for Google services to help with CORS
    if (
      typeof url === "string" &&
      (url.includes("googleads.g.doubleclick.net") ||
        url.includes("www.googletagmanager.com") ||
        url.includes("www.googleadservices.com"))
    ) {
      this.withCredentials = false;
    }

    return originalOpen.call(this, method, url, async, user, password);
  };
</script>
